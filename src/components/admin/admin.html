<!DOCTYPE html>
<html>
<head>
  <title>Football Fans Quiz (Admin)</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; margin-top: 20px;}
    th, td { border: 1px solid #ccc; padding: 6px 12px;}
    button { margin-right: 10px;}
    .timer { font-size: 1.2em; color: red; margin-bottom: 10px;}
    .per-question { color: #666; font-size: 0.9em; }
    .current-q-img {max-width:300px;max-height:200px;border-radius:6px;box-shadow:0 2px 10px #aaa;}
  </style>
</head>
<body>
  <h1>Admin Panel: Football Fans Quiz</h1>
  <button onclick="startQuiz()" id="startBtn">Start Quiz Now</button>
  <button onclick="resetQuiz()">Reset Quiz</button>
  <h2>Participants Waiting</h2>
  <table id="participants">
    <tr><th>Name</th><th>Joined</th></tr>
  </table>
  <h2>Current Question:</h2>
  <div class="timer" id="timer"></div>
  <div id="current-question"></div>
  <h2>Live Leaderboard:</h2>
  <div id="live-leaderboard"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcqhxckrckFP_Wi9ey9ceODrfxXTh-H-w",
      authDomain: "musvn-quizz.firebaseapp.com",
      databaseURL: "https://musvn-quizz-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "musvn-quizz",
      storageBucket: "musvn-quizz.appspot.com",
      messagingSenderId: "38100794938",
      appId: "1:38100794938:web:ab428f85c021f8c966ff03"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const QUESTION_TIME_LIMIT = 10;
    let questionKeys = [];
    let questionData = {};
    let currentQuestionIndex = 0;
    let timerInterval = null;
    let timeLeft = QUESTION_TIME_LIMIT;

    // Universal score calculator
    function calculateScores(questionKeys, questions, allAnswers, participants, QUESTION_TIME_LIMIT = 10) {
      let participantPoints = {};
      let perQuestion = {};
      Object.keys(participants).forEach(pid => {
        participantPoints[pid] = 0;
        perQuestion[pid] = [];
      });

      questionKeys.forEach((qid, qIdx) => {
        const q = questions[qid];
        let correctParticipants = [];
        Object.keys(participants).forEach(pid => {
          let ansObj = {};
          if (allAnswers[pid] && allAnswers[pid][qid]) {
            ansObj = allAnswers[pid][qid];
          }
          let isCorrect = false;
          if (q.type === "fill_text") {
            let correctArr = Array.isArray(q.correct) ? q.correct : [q.correct];
            isCorrect = correctArr.some(ans => ans.trim().toLowerCase() === (ansObj.answer||"").trim().toLowerCase());
          } else {
            isCorrect = ansObj.answer === q.correct;
          }
          if (isCorrect) {
            correctParticipants.push({
              pid,
              timeToAnswer: typeof ansObj.timeToAnswer !== 'undefined' ? ansObj.timeToAnswer : QUESTION_TIME_LIMIT
            });
          }
        });
        correctParticipants.sort((a, b) => a.timeToAnswer - b.timeToAnswer);

        let N = correctParticipants.length;
        let S = N * (N + 1) / 2;
        correctParticipants.forEach((p, i) => {
          let earned = N > 0 ? Math.round(1000 * (N - i) / S) : 0;
          participantPoints[p.pid] += earned;
          perQuestion[p.pid][qIdx] = earned;
        });
        Object.keys(participants).forEach(pid => {
          if (perQuestion[pid][qIdx] === undefined) {
            perQuestion[pid][qIdx] = 0;
          }
        });
      });

      return {participantPoints, perQuestion};
    }

    // Show participants
    db.ref('participants').on('value', snap => {
      const table = document.getElementById('participants');
      table.innerHTML = "<tr><th>Name</th><th>Joined</th></tr>";
      const data = snap.val();
      if (data) {
        Object.values(data).forEach(p => {
          const row = table.insertRow();
          row.insertCell().textContent = p.name;
          row.insertCell().textContent = new Date(p.joined).toLocaleTimeString();
        });
      }
    });

    // Load questions
    db.ref('questions').once('value').then(snapshot => {
      questionData = snapshot.val();
      questionKeys = Object.keys(questionData);
      showCurrentQuestion();
    });

    function startQuiz() {
      document.getElementById('startBtn').disabled = true;
      currentQuestionIndex = 0;
      db.ref('quizState').set({
        started: true,
        currentQuestionIndex: currentQuestionIndex,
        timer: QUESTION_TIME_LIMIT
      });
      timeLeft = QUESTION_TIME_LIMIT;
      showCurrentQuestion();
      startQuestionTimer();
    }

    function resetQuiz() {
      db.ref('quizState').set({started: false});
      db.ref('participants').remove();
      db.ref('scores').remove();
      document.getElementById('current-question').innerHTML = "";
      document.getElementById('timer').textContent = "";
      document.getElementById('live-leaderboard').innerHTML = "";
      document.getElementById('startBtn').disabled = false;
      clearInterval(timerInterval);
    }

    function showCurrentQuestion() {
      if (currentQuestionIndex >= questionKeys.length) {
        document.getElementById('current-question').innerHTML = "<b>Quiz Finished!</b>";
        document.getElementById('timer').textContent = "";
        clearInterval(timerInterval);
        return;
      }
      const qid = questionKeys[currentQuestionIndex];
      const q = questionData[qid];
      let html = "";
      if (q.image) {
        html += `<div><img class="current-q-img" src="${q.image}"></div>`;
      }
      html += `<div><strong>${q.question}</strong></div>`;
      if (q.type === "single_choice") {
        html += q.options.map(opt => `<button disabled>${opt}</button>`).join(' ');
      } else if (q.type === "image_choice") {
        html += `<div style="display:flex;gap:10px;">`;
        q.options.forEach(opt => {
          html += `<div style="text-align:center;">
            <img src="${opt.image}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;"><br>
            <span>${opt.label}</span>
          </div>`;
        });
        html += `</div>`;
      } else if (q.type === "fill_text") {
        html += `<input type="text" disabled placeholder="(Text answer)"/>`;
      }
      document.getElementById('current-question').innerHTML = html;
    }

    function startQuestionTimer() {
      clearInterval(timerInterval);
      timeLeft = QUESTION_TIME_LIMIT;
      db.ref('quizState/timer').set(timeLeft);
      document.getElementById('timer').textContent = `Time left: ${timeLeft}s`;

      timerInterval = setInterval(() => {
        timeLeft--;
        db.ref('quizState/timer').set(timeLeft);
        document.getElementById('timer').textContent = `Time left: ${timeLeft}s`;

        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          currentQuestionIndex++;
          updateLiveLeaderboard();
          if (currentQuestionIndex < questionKeys.length) {
            db.ref('quizState').update({currentQuestionIndex: currentQuestionIndex, timer: QUESTION_TIME_LIMIT});
            showCurrentQuestion();
            setTimeout(startQuestionTimer, 1500);
          } else {
            db.ref('quizState').update({currentQuestionIndex: currentQuestionIndex});
            showCurrentQuestion();
            showFinalLeaderboard();
          }
        }
      }, 1000);
    }

    function updateLiveLeaderboard() {
      let finishedQuestions = questionKeys.slice(0, currentQuestionIndex);
      db.ref('participants').once('value').then(partSnap => {
        const participants = partSnap.val() || {};
        db.ref('quizState/answers').once('value').then(ansSnap => {
          const allAnswers = ansSnap.val() || {};
          db.ref('questions').once('value').then(qSnap => {
            const questions = qSnap.val();

            const {participantPoints, perQuestion} = calculateScores(finishedQuestions, questions, allAnswers, participants, QUESTION_TIME_LIMIT);

            let leaderboardArr = Object.keys(participants).map(pid => ({
              pid,
              name: participants[pid].name,
              points: participantPoints[pid],
              perQuestion: perQuestion[pid]
            }));
            leaderboardArr.sort((a, b) => b.points - a.points);

            let rankHtml = `<h3>Cumulative Leaderboard (after ${finishedQuestions.length} ${finishedQuestions.length === 1 ? 'question' : 'questions'})</h3>
            <table>
              <tr><th>Rank #</th><th>Name</th><th>Points</th><th>Per Question</th></tr>`;
            leaderboardArr.forEach((p, i) => {
              rankHtml += `<tr>
                <td>${i + 1}</td>
                <td>${p.name}</td>
                <td>${p.points}</td>
                <td class="per-question">${
                  p.perQuestion.map((score, idx) => `Q${idx+1}: ${score}`).join(", ")
                }</td>
              </tr>`;
            });
            rankHtml += `</table>`;
            document.getElementById('live-leaderboard').innerHTML = rankHtml;
          });
        });
      });
    }

    function showFinalLeaderboard() {
      db.ref('scores').once('value').then(snap => {
        const scores = snap.val();
        if (!scores) {
          document.getElementById('live-leaderboard').innerHTML = "<p>No scores available.</p>";
          return;
        }
        let scoreArr = Object.values(scores);
        scoreArr.sort((a, b) => b.score - a.score);

        let rankHtml = `<h3>üèÜ Top 3 Overall</h3>
          <table>
            <tr><th>Rank #</th><th>Name</th><th>Points</th></tr>`;
        for (let i = 0; i < Math.min(3, scoreArr.length); i++) {
          rankHtml += `<tr>
            <td>${i + 1}</td>
            <td>${scoreArr[i].name}</td>
            <td>${scoreArr[i].score}</td>
          </tr>`;
        }
        rankHtml += `</table>`;
        document.getElementById('live-leaderboard').innerHTML = rankHtml;
      });
    }
  </script>
</body>
</html>